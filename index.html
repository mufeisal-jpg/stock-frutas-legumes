<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock – Equipa</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e9eefc; --muted:#a9b4d6; --line:#24304d; --accent:#4da3ff; --danger:#ff5b6e; }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(180deg,#070c16,var(--bg));color:var(--text)}
    header{padding:18px 16px 10px;position:sticky;top:0;backdrop-filter:blur(10px);background:rgba(11,18,32,.75);border-bottom:1px solid rgba(36,48,77,.7);z-index:10}
    h1{margin:0;font-size:18px;font-weight:700}
    .sub{margin-top:6px;color:var(--muted);font-size:12px}
    .wrap{padding:14px 16px 90px;max-width:980px;margin:0 auto}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{border:1px solid var(--line);background:rgba(18,26,43,.7);color:var(--text);padding:8px 10px;border-radius:999px;font-size:13px;cursor:pointer;user-select:none}
    .pill.active{border-color:rgba(77,163,255,.9);box-shadow:0 0 0 2px rgba(77,163,255,.15) inset}
    .card{background:rgba(18,26,43,.7);border:1px solid rgba(36,48,77,.8);border-radius:14px;padding:12px;margin-top:12px}
    .card h2{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:700}
    .btn{border:1px solid var(--line);background:rgba(18,26,43,.9);color:var(--text);padding:10px 12px;border-radius:12px;font-size:13px;cursor:pointer}
    .btn.primary{border-color:rgba(77,163,255,.7);background:rgba(77,163,255,.15)}
    .btn.danger{border-color:rgba(255,91,110,.7);background:rgba(255,91,110,.12)}
    .btn:active{transform:translateY(1px)}
    input[type="text"], select{
      width:100%;border:1px solid rgba(36,48,77,.9);background:rgba(7,12,22,.55);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:14px;outline:none
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(36,48,77,.75);vertical-align:middle}
    th{text-align:left;font-size:12px;color:var(--muted);font-weight:700}
    td.name{width:55%;font-size:13px}
    td.qty{width:45%}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .footerbar{
      position:fixed;bottom:0;left:0;right:0;background:rgba(11,18,32,.85);
      border-top:1px solid rgba(36,48,77,.8);padding:10px 12px;display:flex;gap:10px;justify-content:center;backdrop-filter:blur(10px)
    }
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:74px;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.12);color:#fff;
      padding:10px 12px;border-radius:999px;font-size:13px;z-index:20;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    .search{flex:1;min-width:220px}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .box{flex:1;min-width:240px}
    .hr{height:1px;background:rgba(36,48,77,.75);margin:10px 0}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;border:1px solid rgba(36,48,77,.9);font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <h1>Stock – Equipa</h1>
  <div class="sub">Partilhado online (Sheets). Campo livre: “10 kg”, “3 cx”, “12 un”… Só aparece o que ficou (vazio/0 não aparece).</div>
  <div class="pillbar" id="tabs"></div>
</header>

<div class="wrap">
  <div class="row">
    <input class="search" id="search" type="text" placeholder="Pesquisar produto…" />
    <button class="btn" id="btnRefresh">Atualizar</button>
    <button class="btn primary" id="btnCloseDay">Fechar dia</button>
  </div>

  <div class="card">
    <div class="split">
      <div class="box">
        <h2>Vista</h2>
        <div class="row">
          <button class="btn" id="btnViewLeft">Ver só o que ficou</button>
          <button class="btn" id="btnViewAll">Editar todos os produtos</button>
        </div>
        <div class="small" style="margin-top:8px">
          <span class="tag" id="statusTag">—</span>
        </div>
      </div>
      <div class="box">
        <h2>Histórico</h2>
        <div class="row">
          <input id="histDate" type="text" placeholder="AAAA-MM-DD (ex: 2026-02-15)" />
          <button class="btn" id="btnHist">Ver</button>
        </div>
        <div class="small" style="margin-top:8px">Mostra o fecho do dia (só o que ficou).</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="small" id="countInfo">—</div>
  </div>

  <div class="card" id="mainCard">
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr><th>Produto</th><th>Quantidade</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none;">
    <h2 id="histTitle">Histórico</h2>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr><th>Categoria</th><th>Produto</th><th>Quantidade</th></tr>
        </thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="footerbar">
  <button class="btn danger" id="btnHideZero">Ocultar vazios/0</button>
  <button class="btn" id="btnShowAllInCat">Mostrar todos na categoria</button>
</div>

<div class="toast" id="toast"></div>

<script>
  // ======= CONFIG =======
  const API_URL = "https://script.google.com/macros/s/AKfycbzmnqL_SCYM4ipUnKzD93keWVW5585sAzwB-HKN2GobXaMKVuNRJULD3FIJdOQ5ic3K/exec";

  // ======= STATE =======
  let categories = [];
  let catalog = [];         // [{category, product, active}]
  let stockItems = [];      // [{category, product, qtyText, updatedAt, updatedBy}]
  let stockMap = {};        // key => item
  let activeCat = "";
  let viewMode = "left";    // "left" (only non-empty) OR "all" (all products)
  let hideZero = true;

  // ======= HELPERS =======
  const $ = (id) => document.getElementById(id);
  const keyOf = (c,p) => (c+"||"+p);
  const sleep = (ms) => new Promise(r=>setTimeout(r,ms));

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(()=> el.classList.remove("show"), 1400);
  }

  function normQty(q){
    const s = (q||"").trim();
    if(!s) return "";
    const t = s.toLowerCase().replace(/\s+/g,"");
    if(t==="0"||t==="0kg"||t==="0g"||t==="0un"||t==="0cx") return "0";
    return s;
  }

  async function apiGet(params){
    const url = API_URL + "?" + new URLSearchParams(params).toString();
    const res = await fetch(url, { method:"GET" });
    return await res.json();
  }

  async function apiPost(payload){
    const res = await fetch(API_URL, {
      method:"POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  function renderTabs(){
    const tabs = $("tabs");
    tabs.innerHTML = "";
    categories.forEach(cat=>{
      const b = document.createElement("button");
      b.className = "pill" + (cat===activeCat ? " active" : "");
      b.textContent = cat;
      b.onclick = ()=> { activeCat = cat; renderAll(); };
      tabs.appendChild(b);
    });
  }

  function getProductsForCat(cat){
    return catalog
      .filter(x => x.active && x.category === cat)
      .map(x => x.product)
      .sort((a,b)=>a.localeCompare(b,"pt",{sensitivity:"base"}));
  }

  function getVisibleProductsForCat(cat){
    const all = getProductsForCat(cat);
    const search = ($("search").value||"").trim().toLowerCase();

    let list = all;
    if(search) list = list.filter(n => n.toLowerCase().includes(search));

    if(viewMode === "left"){
      list = list.filter(name=>{
        const item = stockMap[keyOf(cat,name)];
        const q = normQty(item ? item.qtyText : "");
        if(!q) return false;
        if(hideZero && q==="0") return false;
        return true;
      });
    } else {
      // viewMode all (editing): optionally hide empties
      if(hideZero){
        // hide only explicit 0, keep empties visible so editing is easy
        list = list.filter(name=>{
          const item = stockMap[keyOf(cat,name)];
          const q = normQty(item ? item.qtyText : "");
          return q !== "0";
        });
      }
    }
    return list;
  }

  function setStatusTag(text){ $("statusTag").textContent = text; }

  function renderTable(){
    const tbody = $("tableBody");
    tbody.innerHTML = "";

    const list = getVisibleProductsForCat(activeCat);

    $("countInfo").textContent = `${activeCat}: ${list.length} produto(s)`;
    if(list.length === 0){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 2;
      td.className = "small muted";
      td.style.padding = "14px 8px";
      td.textContent = viewMode==="left"
        ? "Não há produtos com stock registado nesta categoria (ou estão vazios/0)."
        : "Sem produtos ativos nesta categoria.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach(name=>{
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.className = "name";
      tdName.textContent = name;

      const tdQty = document.createElement("td");
      tdQty.className = "qty";

      const inp = document.createElement("input");
      inp.type = "text";
      inp.placeholder = "ex: 10 kg / 3 cx / 12 un";
      const item = stockMap[keyOf(activeCat,name)];
      inp.value = item ? (item.qtyText || "") : "";

      let t;
      inp.oninput = ()=>{
        clearTimeout(t);
        t = setTimeout(async ()=>{
          const val = inp.value;
          setStatusTag("A gravar…");
          const r = await apiPost({ action:"upsertStock", category: activeCat, product: name, qtyText: val });
          if(r && r.ok){
            // update local map
            stockMap[keyOf(activeCat,name)] = { category: activeCat, product: name, qtyText: val };
            setStatusTag("Gravado");
            if(viewMode==="left"){
              // if you clear it, it should disappear
              renderTable();
            }
          } else {
            setStatusTag("Erro a gravar");
            alert("Não consegui gravar. Confirma permissões / login Google.");
          }
        }, 400);
      };

      tdQty.appendChild(inp);
      tr.appendChild(tdName);
      tr.appendChild(tdQty);
      tbody.appendChild(tr);
    });
  }

  function renderHistory(rows, dateStr){
    $("historyCard").style.display = "block";
    $("mainCard").style.display = "none";

    $("histTitle").textContent = `Histórico – ${dateStr || "data"}`;
    const tbody = $("histBody");
    tbody.innerHTML = "";

    if(!rows.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 3;
      td.className = "small muted";
      td.style.padding = "14px 8px";
      td.textContent = "Sem registos para essa data.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r=>{
      const tr = document.createElement("tr");
      const tdC = document.createElement("td"); tdC.textContent = r.category;
      const tdP = document.createElement("td"); tdP.textContent = r.product;
      const tdQ = document.createElement("td"); tdQ.textContent = r.qtyText;
      tr.appendChild(tdC); tr.appendChild(tdP); tr.appendChild(tdQ);
      tbody.appendChild(tr);
    });
  }

  function showMain(){
    $("historyCard").style.display = "none";
    $("mainCard").style.display = "block";
  }

  async function refreshAll(){
    setStatusTag("A carregar…");
    const cat = await apiGet({ action:"getCatalog" });
    if(!cat.ok){ setStatusTag("Erro"); alert("Erro a ler catálogo"); return; }
    categories = cat.categories || [];
    catalog = cat.catalog || [];
    activeCat = activeCat || categories[0] || "Frutas";

    const st = await apiGet({ action:"getStock" });
    stockItems = (st.ok ? st.items : []) || [];
    stockMap = {};
    stockItems.forEach(it=> stockMap[keyOf(it.category,it.product)] = it);

    renderTabs();
    renderAll();
    setStatusTag("Pronto");
  }

  function renderAll(){
    showMain();
    renderTabs();
    renderTable();
    $("btnViewLeft").textContent = viewMode==="left" ? "✅ Ver só o que ficou" : "Ver só o que ficou";
    $("btnViewAll").textContent  = viewMode==="all"  ? "✅ Editar todos os produtos" : "Editar todos os produtos";
    $("btnHideZero").textContent = hideZero ? "✅ Ocultar vazios/0" : "Ocultar vazios/0";
  }

  // ======= EVENTS =======
  $("search").addEventListener("input", ()=> renderTable());

  $("btnRefresh").onclick = refreshAll;

  $("btnViewLeft").onclick = ()=> { viewMode="left"; toast("A mostrar só o que ficou"); renderAll(); };
  $("btnViewAll").onclick  = ()=> { viewMode="all";  toast("A editar todos"); renderAll(); };

  $("btnHideZero").onclick = ()=> { hideZero = !hideZero; renderAll(); };

  $("btnShowAllInCat").onclick = ()=>{
    // shortcut: switch to all for the current category
    viewMode = "all";
    renderAll();
    toast("A mostrar todos na categoria");
  };

  $("btnCloseDay").onclick = async ()=>{
    const today = new Date().toISOString().slice(0,10);
    const dateStr = prompt("Que data queres fechar? (AAAA-MM-DD)", today);
    if(!dateStr) return;

    setStatusTag("A fechar dia…");
    const r = await apiPost({ action:"closeDay", date: dateStr });
    if(r && r.ok){
      toast(`Dia fechado (${r.saved} linhas)`);
      setStatusTag("Dia fechado");
      // refresh to ensure "left view" is accurate
      await sleep(300);
      await refreshAll();
    } else {
      setStatusTag("Erro");
      alert("Não consegui fechar o dia. Confirma permissões / login Google.");
    }
  };

  $("btnHist").onclick = async ()=>{
    const dateStr = ($("histDate").value||"").trim();
    if(!dateStr){ alert("Escreve uma data (AAAA-MM-DD)"); return; }

    setStatusTag("A ler histórico…");
    const r = await apiGet({ action:"getHistory", date: dateStr });
    if(r && r.ok){
      renderHistory(r.rows || [], dateStr);
      setStatusTag("Pronto");
    } else {
      setStatusTag("Erro");
      alert("Não consegui ler histórico.");
    }
  };

  // ======= START =======
  (async function(){
    viewMode = "left";
    hideZero = true;
    await refreshAll();
  })();
</script>
</body>
</html>
